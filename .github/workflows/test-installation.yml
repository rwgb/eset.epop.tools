name: Test ESET Protect Installation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/linux/install-eset.sh'
      - '.github/workflows/test-installation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/linux/install-eset.sh'
      - '.github/workflows/test-installation.yml'
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Ubuntu ${{ matrix.ubuntu-version }}
        id: test
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:${{ matrix.ubuntu-version }} \
            bash -c '
              # Update package list
              apt-get update -qq
              
              # Install basic dependencies for testing
              DEBIAN_FRONTEND=noninteractive apt-get install -y wget curl sudo systemctl
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection is correct
              if [ "$OS_TYPE" != "ubuntu" ] && [ "$OS_TYPE" != "debian" ]; then
                echo "ERROR: OS detection failed. Expected ubuntu/debian, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Ubuntu ${{ matrix.ubuntu-version }}"
            ' > ubuntu-${{ matrix.ubuntu-version }}.log 2>&1 || {
            echo "FAILED" > ubuntu-${{ matrix.ubuntu-version }}.status
            exit 1
          }
      
      - name: Capture failure details
        if: failure()
        run: |
          mkdir -p test-logs
          {
            echo "=========================================="
            echo "Test Failed: Ubuntu ${{ matrix.ubuntu-version }}"
            echo "=========================================="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Runner: ${{ runner.os }}"
            echo ""
            echo "Failure Details:"
            cat ubuntu-${{ matrix.ubuntu-version }}.log 2>/dev/null || echo "No log file generated"
            echo ""
            echo "Exit Status:"
            cat ubuntu-${{ matrix.ubuntu-version }}.status 2>/dev/null || echo "Test command failed"
            echo ""
          } > test-logs/ubuntu-${{ matrix.ubuntu-version }}-failure.log
      
      - name: Upload failure logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-${{ matrix.ubuntu-version }}-logs
          path: test-logs/
          retention-days: 30

  test-debian:
    name: Test on Debian ${{ matrix.debian-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        debian-version: ['11', '12']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Debian ${{ matrix.debian-version }}
        id: test
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:${{ matrix.debian-version }} \
            bash -c '
              # Update package list
              apt-get update -qq
              
              # Install basic dependencies
              DEBIAN_FRONTEND=noninteractive apt-get install -y wget curl sudo systemctl
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "debian" ]; then
                echo "ERROR: OS detection failed. Expected debian, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Debian ${{ matrix.debian-version }}"
            ' > debian-${{ matrix.debian-version }}.log 2>&1 || {
            echo "FAILED" > debian-${{ matrix.debian-version }}.status
            exit 1
          }
      
      - name: Capture failure details
        if: failure()
        run: |
          mkdir -p test-logs
          {
            echo "=========================================="
            echo "Test Failed: Debian ${{ matrix.debian-version }}"
            echo "=========================================="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Runner: ${{ runner.os }}"
            echo ""
            echo "Failure Details:"
            cat debian-${{ matrix.debian-version }}.log 2>/dev/null || echo "No log file generated"
            echo ""
            echo "Exit Status:"
            cat debian-${{ matrix.debian-version }}.status 2>/dev/null || echo "Test command failed"
            echo ""
          } > test-logs/debian-${{ matrix.debian-version }}-failure.log
      
      - name: Upload failure logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debian-${{ matrix.debian-version }}-logs
          path: test-logs/
          retention-days: 30

  test-rhel-based:
    name: Test on ${{ matrix.os-name }} ${{ matrix.os-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os-name: 'Rocky Linux'
            os-image: 'rockylinux/rockylinux'
            os-version: '8'
          - os-name: 'Rocky Linux'
            os-image: 'rockylinux/rockylinux'
            os-version: '9'
          - os-name: 'AlmaLinux'
            os-image: 'almalinux'
            os-version: '8'
          - os-name: 'AlmaLinux'
            os-image: 'almalinux'
            os-version: '9'
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on ${{ matrix.os-name }} ${{ matrix.os-version }}
        id: test
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ matrix.os-image }}:${{ matrix.os-version }} \
            bash -c '
              # Install basic dependencies
              yum install -y wget curl sudo which
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "rhel" ] && [ "$OS_TYPE" != "centos" ] && [ "$OS_TYPE" != "rocky" ] && [ "$OS_TYPE" != "almalinux" ]; then
                echo "ERROR: OS detection failed for RHEL-based system, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for ${{ matrix.os-name }} ${{ matrix.os-version }}"
            ' > rhel-${{ matrix.os-version }}.log 2>&1 || {
            echo "FAILED" > rhel-${{ matrix.os-version }}.status
            exit 1
          }
      
      - name: Capture failure details
        if: failure()
        run: |
          mkdir -p test-logs
          OS_SLUG=$(echo "${{ matrix.os-name }}" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          {
            echo "=========================================="
            echo "Test Failed: ${{ matrix.os-name }} ${{ matrix.os-version }}"
            echo "=========================================="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Runner: ${{ runner.os }}"
            echo "Image: ${{ matrix.os-image }}:${{ matrix.os-version }}"
            echo ""
            echo "Failure Details:"
            cat rhel-${{ matrix.os-version }}.log 2>/dev/null || echo "No log file generated"
            echo ""
            echo "Exit Status:"
            cat rhel-${{ matrix.os-version }}.status 2>/dev/null || echo "Test command failed"
            echo ""
          } > test-logs/${OS_SLUG}-${{ matrix.os-version }}-failure.log
      
      - name: Upload failure logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rhel-${{ matrix.os-name }}-${{ matrix.os-version }}-logs
          path: test-logs/
          retention-days: 30

  test-fedora:
    name: Test on Fedora ${{ matrix.fedora-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fedora-version: ['38', '39', '40']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Fedora ${{ matrix.fedora-version }}
        id: test
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            fedora:${{ matrix.fedora-version }} \
            bash -c '
              # Install basic dependencies
              dnf install -y wget curl sudo which
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "fedora" ]; then
                echo "ERROR: OS detection failed. Expected fedora, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Fedora ${{ matrix.fedora-version }}"
            ' > fedora-${{ matrix.fedora-version }}.log 2>&1 || {
            echo "FAILED" > fedora-${{ matrix.fedora-version }}.status
            exit 1
          }
      
      - name: Capture failure details
        if: failure()
        run: |
          mkdir -p test-logs
          {
            echo "=========================================="
            echo "Test Failed: Fedora ${{ matrix.fedora-version }}"
            echo "=========================================="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Runner: ${{ runner.os }}"
            echo ""
            echo "Failure Details:"
            cat fedora-${{ matrix.fedora-version }}.log 2>/dev/null || echo "No log file generated"
            echo ""
            echo "Exit Status:"
            cat fedora-${{ matrix.fedora-version }}.status 2>/dev/null || echo "Test command failed"
            echo ""
          } > test-logs/fedora-${{ matrix.fedora-version }}-failure.log
      
      - name: Upload failure logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fedora-${{ matrix.fedora-version }}-logs
          path: test-logs/
          retention-days: 30

  test-dry-run:
    name: Dry Run Installation Test
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
      - name: Validate script structure
        run: |
          # Check for common issues
          echo "Checking for hardcoded passwords..."
          if grep -E "PASSWORD=.+" scripts/linux/install-eset.sh | grep -v "prompt_credentials" | grep -v "MYSQL_ROOT_PASSWORD="; then
            echo "Warning: Potential hardcoded passwords found"
          fi
          
          echo "Checking for proper error handling..."
          if ! grep -q "set -e" scripts/linux/install-eset.sh; then
            echo "Warning: Script may not exit on errors"
          fi
          
          echo "Checking for required functions..."
          required_functions=("check_os" "prompt_credentials" "detect_java_home")
          for func in "${required_functions[@]}"; do
            if ! grep -q "^${func}()" scripts/linux/install-eset.sh; then
              echo "ERROR: Required function $func not found"
              exit 1
            fi
          done
          
          echo "✓ All validation checks passed"

      - name: Test script help/usage
        run: |
          chmod +x scripts/linux/install-eset.sh
          
          # Test if script can display help (if implemented)
          if scripts/linux/install-eset.sh --help 2>&1 | grep -q "Usage"; then
            echo "✓ Help text available"
          else
            echo "ℹ No help text implemented (optional)"
          fi
      
      - name: Test non-interactive mode with environment variables
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e MYSQL_ROOT_PASSWORD="${TEST_MYSQL_PASSWORD:-TestPass123}" \
            -e ESET_ADMIN_PASSWORD="${TEST_ADMIN_PASSWORD:-TestPass123}" \
            -e DB_USER_USERNAME="era_user" \
            -e DB_USER_PASSWORD="${TEST_DB_PASSWORD:-TestPass123}" \
            -e CI=true \
            ubuntu:24.04 \
            bash -c '
              # Update and install dependencies
              apt-get update -qq
              DEBIAN_FRONTEND=noninteractive apt-get install -y wget curl sudo systemctl
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test that script accepts environment variables (dry run to credentials check)
              # This will test non-interactive credential handling without full installation
              export -p | grep -E "MYSQL_ROOT_PASSWORD|ESET_ADMIN_PASSWORD|DB_USER"
              
              # Source the script to test prompt_credentials function
              source scripts/linux/install-eset.sh
              
              # Call prompt_credentials to verify it uses env vars
              prompt_credentials
              
              echo "✓ Non-interactive mode with environment variables works correctly"
            ' || {
            echo "FAILED: Non-interactive mode test failed"
            exit 1
          }

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security checks
        run: |
          echo "Scanning for common security issues..."
          
          # Check for use of wget/curl without verification
          if grep -E "(wget|curl).*--no-check-certificate" scripts/linux/install-eset.sh; then
            echo "WARNING: Certificate verification disabled"
          fi
          
          # Check for eval usage
          if grep "eval" scripts/linux/install-eset.sh; then
            echo "WARNING: eval usage detected - review for security"
          fi
          
          # Check for temporary file usage
          if grep -E ">/tmp/|mktemp" scripts/linux/install-eset.sh; then
            echo "ℹ Temporary files used - ensure proper cleanup"
          fi
          
          echo "✓ Security scan completed"
  combine-logs:
    name: Combine Test Logs
    runs-on: ubuntu-latest
    needs: [shellcheck, test-ubuntu, test-debian, test-rhel-based, test-fedora, test-dry-run, security-scan]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-logs
        continue-on-error: true
      
      - name: Combine all logs
        run: |
          mkdir -p combined-logs
          
          # Create combined diagnostic log
          {
            echo "=========================================="
            echo "ESET Protect Installation Test Report"
            echo "=========================================="
            echo "Workflow: ${{ github.workflow }}"
            echo "Run Number: ${{ github.run_number }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Triggered by: ${{ github.event_name }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "=========================================="
            echo "Test Results Summary"
            echo "=========================================="
            echo "ShellCheck: ${{ needs.shellcheck.result }}"
            echo "Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
            echo "Debian Tests: ${{ needs.test-debian.result }}"
            echo "RHEL-based Tests: ${{ needs.test-rhel-based.result }}"
            echo "Fedora Tests: ${{ needs.test-fedora.result }}"
            echo "Dry Run Tests: ${{ needs.test-dry-run.result }}"
            echo "Security Scan: ${{ needs.security-scan.result }}"
            echo ""
            
            # Count failures
            FAILURES=0
            [ "${{ needs.shellcheck.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.test-ubuntu.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.test-debian.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.test-rhel-based.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.test-fedora.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.test-dry-run.result }}" != "success" ] && ((FAILURES++))
            [ "${{ needs.security-scan.result }}" != "success" ] && ((FAILURES++))
            
            echo "Total Failed Jobs: $FAILURES"
            echo ""
            
            if [ $FAILURES -eq 0 ]; then
              echo "✅ All tests passed successfully!"
            else
              echo "❌ $FAILURES test job(s) failed"
              echo ""
              echo "=========================================="
              echo "Detailed Failure Logs"
              echo "=========================================="
              echo ""
              
              # Combine all failure logs
              if [ -d "all-logs" ]; then
                for log_dir in all-logs/*/; do
                  if [ -d "$log_dir" ]; then
                    for log_file in "$log_dir"*.log; do
                      if [ -f "$log_file" ]; then
                        cat "$log_file"
                        echo ""
                        echo "----------------------------------------"
                        echo ""
                      fi
                    done
                  fi
                done
              else
                echo "No failure logs found (artifacts may not have been uploaded)"
              fi
            fi
            
            echo ""
            echo "=========================================="
            echo "Diagnostic Information"
            echo "=========================================="
            echo ""
            echo "To investigate failures:"
            echo "1. Review the specific test logs above"
            echo "2. Check the GitHub Actions run at:"
            echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "3. Download individual test artifacts for detailed analysis"
            echo "4. Run the failing test locally using the same Docker image"
            
            echo "- Permission issues"
            echo "- Network connectivity problems"
            echo ""
          } > combined-logs/test-diagnostic-report.log
          
          # Show summary in workflow
          cat combined-logs/test-diagnostic-report.log
      
      - name: Upload combined diagnostic log
        uses: actions/upload-artifact@v4
        with:
          name: combined-diagnostic-report
          path: combined-logs/test-diagnostic-report.log
          retention-days: 90
      
      - name: Set final status
        run: |
          FAILURES=0
          [ "${{ needs.shellcheck.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.test-ubuntu.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.test-debian.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.test-rhel-based.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.test-fedora.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.test-dry-run.result }}" != "success" ] && ((FAILURES++))
          [ "${{ needs.security-scan.result }}" != "success" ] && ((FAILURES++))
          
          if [ $FAILURES -gt 0 ]; then
            echo "::warning::$FAILURES test job(s) failed - check the combined diagnostic report artifact"
          fix/install-eset.sh; then
            echo "ℹ Temporary files used - ensure proper cleanup"
          fi
          
          echo "✓ Security scan completed"

  integration-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, test-ubuntu, test-debian, test-rhel-based, test-fedora, test-dry-run, security-scan]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Test Results Summary:"
          echo "===================="
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
          echo "Debian Tests: ${{ needs.test-debian.result }}"
          echo "RHEL-based Tests: ${{ needs.test-rhel-based.result }}"
          echo "Fedora Tests: ${{ needs.test-fedora.result }}"
          echo "Dry Run Tests: ${{ needs.test-dry-run.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          if [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.test-ubuntu.result }}" != "success" ] || \
             [ "${{ needs.test-debian.result }}" != "success" ] || \
             [ "${{ needs.test-rhel-based.result }}" != "success" ] || \
             [ "${{ needs.test-fedora.result }}" != "success" ] || \
             [ "${{ needs.test-dry-run.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi
          
          echo "✅ All tests passed successfully!"
