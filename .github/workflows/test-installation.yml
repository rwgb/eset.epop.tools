name: Test ESET Protect Installation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/linux/install-eset.sh'
      - '.github/workflows/test-installation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/linux/install-eset.sh'
      - '.github/workflows/test-installation.yml'
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Ubuntu ${{ matrix.ubuntu-version }}
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:${{ matrix.ubuntu-version }} \
            bash -c '
              # Update package list
              apt-get update -qq
              
              # Install basic dependencies for testing
              DEBIAN_FRONTEND=noninteractive apt-get install -y wget curl sudo systemctl
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection is correct
              if [ "$OS_TYPE" != "ubuntu" ] && [ "$OS_TYPE" != "debian" ]; then
                echo "ERROR: OS detection failed. Expected ubuntu/debian, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Ubuntu ${{ matrix.ubuntu-version }}"
            '

  test-debian:
    name: Test on Debian ${{ matrix.debian-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        debian-version: ['11', '12']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Debian ${{ matrix.debian-version }}
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:${{ matrix.debian-version }} \
            bash -c '
              # Update package list
              apt-get update -qq
              
              # Install basic dependencies
              DEBIAN_FRONTEND=noninteractive apt-get install -y wget curl sudo systemctl
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "debian" ]; then
                echo "ERROR: OS detection failed. Expected debian, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Debian ${{ matrix.debian-version }}"
            '

  test-rhel-based:
    name: Test on ${{ matrix.os-name }} ${{ matrix.os-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os-name: 'Rocky Linux'
            os-image: 'rockylinux/rockylinux'
            os-version: '8'
          - os-name: 'Rocky Linux'
            os-image: 'rockylinux/rockylinux'
            os-version: '9'
          - os-name: 'AlmaLinux'
            os-image: 'almalinux'
            os-version: '8'
          - os-name: 'AlmaLinux'
            os-image: 'almalinux'
            os-version: '9'
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on ${{ matrix.os-name }} ${{ matrix.os-version }}
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ matrix.os-image }}:${{ matrix.os-version }} \
            bash -c '
              # Install basic dependencies
              yum install -y wget curl sudo which
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "rhel" ] && [ "$OS_TYPE" != "centos" ] && [ "$OS_TYPE" != "rocky" ] && [ "$OS_TYPE" != "almalinux" ]; then
                echo "ERROR: OS detection failed for RHEL-based system, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for ${{ matrix.os-name }} ${{ matrix.os-version }}"
            '

  test-fedora:
    name: Test on Fedora ${{ matrix.fedora-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fedora-version: ['38', '39', '40']
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test on Fedora ${{ matrix.fedora-version }}
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            fedora:${{ matrix.fedora-version }} \
            bash -c '
              # Install basic dependencies
              dnf install -y wget curl sudo which
              
              # Make script executable
              chmod +x scripts/linux/install-eset.sh
              
              # Test script syntax
              bash -n scripts/linux/install-eset.sh
              
              # Test OS detection
              source scripts/linux/install-eset.sh
              check_os
              echo "OS Type detected: $OS_TYPE"
              
              # Verify OS detection
              if [ "$OS_TYPE" != "fedora" ]; then
                echo "ERROR: OS detection failed. Expected fedora, got: $OS_TYPE"
                exit 1
              fi
              
              echo "✓ Script validation passed for Fedora ${{ matrix.fedora-version }}"
            '

  test-dry-run:
    name: Dry Run Installation Test
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
      - name: Validate script structure
        run: |
          # Check for common issues
          echo "Checking for hardcoded passwords..."
          if grep -E "PASSWORD=.+" scripts/linux/install-eset.sh | grep -v "prompt_credentials" | grep -v "MYSQL_ROOT_PASSWORD="; then
            echo "Warning: Potential hardcoded passwords found"
          fi
          
          echo "Checking for proper error handling..."
          if ! grep -q "set -e" scripts/linux/install-eset.sh; then
            echo "Warning: Script may not exit on errors"
          fi
          
          echo "Checking for required functions..."
          required_functions=("check_os" "prompt_credentials" "detect_java_home")
          for func in "${required_functions[@]}"; do
            if ! grep -q "^${func}()" scripts/linux/install-eset.sh; then
              echo "ERROR: Required function $func not found"
              exit 1
            fi
          done
          
          echo "✓ All validation checks passed"

      - name: Test script help/usage
        run: |
          chmod +x scripts/linux/install-eset.sh
          
          # Test if script can display help (if implemented)
          if scripts/linux/install-eset.sh --help 2>&1 | grep -q "Usage"; then
            echo "✓ Help text available"
          else
            echo "ℹ No help text implemented (optional)"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security checks
        run: |
          echo "Scanning for common security issues..."
          
          # Check for use of wget/curl without verification
          if grep -E "(wget|curl).*--no-check-certificate" scripts/linux/install-eset.sh; then
            echo "WARNING: Certificate verification disabled"
          fi
          
          # Check for eval usage
          if grep "eval" scripts/linux/install-eset.sh; then
            echo "WARNING: eval usage detected - review for security"
          fi
          
          # Check for temporary file usage
          if grep -E ">/tmp/|mktemp" scripts/linux/install-eset.sh; then
            echo "ℹ Temporary files used - ensure proper cleanup"
          fi
          
          echo "✓ Security scan completed"

  integration-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, test-ubuntu, test-debian, test-rhel-based, test-fedora, test-dry-run, security-scan]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Test Results Summary:"
          echo "===================="
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
          echo "Debian Tests: ${{ needs.test-debian.result }}"
          echo "RHEL-based Tests: ${{ needs.test-rhel-based.result }}"
          echo "Fedora Tests: ${{ needs.test-fedora.result }}"
          echo "Dry Run Tests: ${{ needs.test-dry-run.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          if [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.test-ubuntu.result }}" != "success" ] || \
             [ "${{ needs.test-debian.result }}" != "success" ] || \
             [ "${{ needs.test-rhel-based.result }}" != "success" ] || \
             [ "${{ needs.test-fedora.result }}" != "success" ] || \
             [ "${{ needs.test-dry-run.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi
          
          echo "✅ All tests passed successfully!"
